name: Cross-Repo File Transfer

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 */6 * * *"  # every 6 hours (adjust as needed)
  push:
    branches:
      - main

jobs:
  sync-file:
    runs-on: ubuntu-latest
    name: Transfer File and Create Merge Request

    env:
      SOURCE_REPO: "krnchittora2/portfolio"
      DEST_REPO: "krnchittora2/Cross-Project-File-Transfer-Pipeline"
      DEST_BRANCH: "file-update"
      MERGE_BRANCH: "test"
      FILE_PATH: "README.md"
      COMMIT_MESSAGE: "Auto-transfer: Updated file from source repo"
      GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    steps:
      # Step 1: Checkout the destination repo (target repo)
      - name: Checkout destination repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DEST_REPO }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: destination
          clean: true  # ensures workspace is reset every time

      # Step 2: Checkout the source repo (where file comes from)
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: source
          clean: true

      # Step 3: Compare and copy only if changed
      - name: Compare and copy file if updated
        id: filecheck
        run: |
          SRC_FILE="source/README.md"
          DEST_FILE="destination/README.md"

          if [ ! -f "$SRC_FILE" ]; then
            echo "❌ Source file not found: $SRC_FILE"
            exit 1
          fi

          mkdir -p "$(dirname "$DEST_FILE")"

          if cmp -s "$SRC_FILE" "$DEST_FILE"; then
            echo "✅ Files are identical, skipping copy."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            cp "$SRC_FILE" "$DEST_FILE"
            echo "✅ File copied successfully."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # Step 4: Skip PR creation if no file changes
      - name: Skip if no changes
        if: steps.filecheck.outputs.changed == 'false'
        run: echo "🟢 No updates detected. Skipping PR creation."

      # Step 5: Commit and create a pull request (only if changed)
      - name: Commit and create PR
        if: steps.filecheck.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: destination
          commit-message: "Auto-transfer: Synced README.md from ${{ env.SOURCE_REPO }}"
          branch: ${{ env.MERGE_BRANCH }}
          base: ${{ env.DEST_BRANCH }}
          title: "Auto PR: Sync README.md from ${{ env.SOURCE_REPO }}"
          body: |
            This PR automatically syncs README.md from the ${{ env.SOURCE_REPO }} repository.

            - Source: ${{ env.SOURCE_REPO }}
            - Target: ${{ env.MERGE_BRANCH }}
            - Triggered by: ${{ github.event_name }} event

          labels: automated-sync
          delete-branch: false
          draft: false

